name: Secure_Code_Runner
on:
  repository_dispatch:
    types: [run_submission]

jobs:
  execute:
    runs-on: ubuntu-latest
    timeout-minutes: 5 
    
    steps:
      - name: Initialize Workspace
        run: |
          # Write files locally on the VM first
          cat << 'EOF' > solution.py
          ${{ github.event.client_payload.code }}
          EOF
          cat << 'EOF' > tests.py
          ${{ github.event.client_payload.tests }}
          EOF

      - name: Run in Hardened Container
        id: sandbox
        run: |
          # We run the code inside a Docker container for isolation
          # --network none: Blocks all internet access
          # --memory: Hard limit on RAM (128MB is plenty for logic)
          # --cpus: Hard limit on CPU usage
          # -v: Mounts current directory into /app inside the container
          
          docker run --rm \
            --network none \
            --memory "128m" \
            --cpus "0.5" \
            -v $(pwd):/app \
            -w /app \
            python:3.10-slim \
            bash -c "timeout 5s python3 tests.py" > result.txt 2>&1 || echo "Execution Limit Exceeded or Script Error" >> result.txt
          
          # Encode result to Base64 so it can safely pass through the JSON payload
          echo "output_b64=$(cat result.txt | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Send Callback
        if: always() # Ensure the user always gets an answer
        run: |
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: application/json" \
          -d '{
            "submission_id": "${{ github.event.client_payload.submission_id }}",
            "status": "${{ job.status }}",
            "output": "${{ steps.sandbox.outputs.output_b64 || 'Tm8gb3V0cHV0IGdlbmVyYXRlZC4=' }}"
          }'